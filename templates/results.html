<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¡ç®—ç»“æœ - è®¢å•æŒ‡æ ‡è®¡ç®—å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“Š è®¢å•æŒ‡æ ‡è®¡ç®—ç»“æœ</h2>
        <a href="/" class="btn btn-outline-secondary">è¿”å›é¦–é¡µ</a>
    </div>

	<!-- æ±‡æ€»ä¿¡æ¯å¡ç‰‡ï¼ˆå·¦ï¼šæ—¥æœŸç­›é€‰ï¼›å³ï¼šç»¼åˆç»Ÿè®¡ï¼‰ -->
	<div class="row mb-4">
		<div class="col-md-6">
			<div class="card stats-card h-100">
				<div class="card-body">
					<form method="post" action="{{ url_for('process_province') if province_results else url_for('process') }}">
						<div class="row g-2 align-items-end">
							<div class="col-12">
								<small class="text-muted d-block mb-1">æ—¥æœŸèŒƒå›´</small>
							</div>
							<div class="col-6">
								<label for="start_date" class="form-label mb-1">å¼€å§‹</label>
								<input type="date" id="start_date" name="start_date" class="form-control form-control-sm" value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" required>
							</div>
							<div class="col-6">
								<label for="end_date" class="form-label mb-1">ç»“æŸ</label>
								<input type="date" id="end_date" name="end_date" class="form-control form-control-sm" value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" required>
							</div>
							<div class="col-12 d-grid mt-1">
								<button type="submit" class="btn btn-primary btn-sm">é‡æ–°è®¡ç®—</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card stats-card h-100">
				<div class="card-body stats-center text-center">
					<div class="row w-100">
						<div class="col-4">
							<h3 class="mb-1">{{ total_files }}</h3>
							<p class="mb-0">å¤„ç†æ–‡ä»¶æ•°</p>
						</div>
						<div class="col-4">
							<h3 class="mb-1">{{ sku_count }}</h3>
							<p class="mb-0">SKU æ•°é‡</p>
						</div>
						<div class="col-4">
							<h3 class="mb-1">{{ total_orders }}</h3>
							<p class="mb-0">æ€»è®¢å•æ•°</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <!-- ä¸‹è½½æŒ‰é’® -->
    <div class="text-center mb-4">
        <a href="/download/{{ temp_filename }}" class="btn btn-success btn-lg px-4">
            ğŸ“¥ ä¸‹è½½ Excel æ–‡ä»¶
        </a>
    </div>

    <!-- ç»“æœè¡¨æ ¼ -->
    <div class="card elevated">
        <div class="card-header">
            <h5 class="mb-0">è¯¦ç»†æŒ‡æ ‡æ•°æ®</h5>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover mb-0">
                <thead class="sticky-top">
                    <tr>
                        <th>åºå·</th>
                        <th>Seller SKU</th>
                        <th>è®¢å•æ•°</th>
                        <th>ç­¾æ”¶ç‡ (%)</th>
                        <th>å·²å®Œæˆç‡ (%)</th>
                        <th>å·²é€è¾¾ç‡ (%)</th>
                        <th>é€€æ¬¾ç‡ (%)</th>
                        <th>å‘è´§å‰å–æ¶ˆç‡ (%)</th>
                        <th>å‘è´§åå–æ¶ˆç‡ (%)</th>
                        <th>ä»åœ¨é€”ç‡ (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td class="fw-bold">{{ row.seller_sku }}</td>
                        <td>{{ row.total }}</td>
                        <td>
                            <span class="percentage {% if row.sign_rate >= 80 %}good{% elif row.sign_rate >= 60 %}warning{% else %}danger{% endif %}">
                                {{ row.sign_rate }}%
                            </span>
                        </td>
                        <td>
                            {{ row.completed_rate }}%
                        </td>
                        <td>
                            {{ row.delivered_rate }}%
                        </td>
                        <td>
                            <span class="percentage {% if row.refund_rate <= 5 %}good{% elif row.refund_rate <= 10 %}warning{% else %}danger{% endif %}">
                                {{ row.refund_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage {% if row.cancel_before_rate <= 5 %}good{% elif row.cancel_before_rate <= 10 %}warning{% else %}danger{% endif %}">
                                {{ row.cancel_before_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage {% if row.cancel_after_rate <= 3 %}good{% elif row.cancel_after_rate <= 8 %}warning{% else %}danger{% endif %}">
                                {{ row.cancel_after_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage">{{ row.in_transit_rate }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% if province_results %}
<!-- SKU è¿‡æ»¤æ§ä»¶ -->
<div class="d-flex justify-content-start mb-2 mt-4">
    <div class="input-group" style="max-width: 360px;">
        <span class="input-group-text">Seller SKU</span>
        <select class="form-select" id="skuFilter">
            <option value="">å…¨éƒ¨</option>
            {% for g in province_results|groupby('seller_sku') %}
            <option value="{{ g.grouper }}">{{ g.grouper }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card elevated">
    <div class="card-header">
        <h5 class="mb-0">çœä»½æŒ‡æ ‡æ•°æ®</h5>
    </div>
    <div class="table-container">
        <table class="table table-striped table-hover mb-0" id="provinceTable">
            <thead class="sticky-top">
                <tr>
                    <th>åºå·</th>
                    <th>Seller SKU</th>
                    <th>çœä»½</th>
                    <th>è®¢å•æ•°</th>
                    <th>è®¢å•å æ¯” (%)</th>
                    <th>ç­¾æ”¶ç‡ (%)</th>
                    <th>å·²å®Œæˆç‡ (%)</th>
                    <th>å·²é€è¾¾ç‡ (%)</th>
                    <th>é€€æ¬¾ç‡ (%)</th>
                    <th>å‘è´§å‰å–æ¶ˆç‡ (%)</th>
                    <th>å‘è´§åå–æ¶ˆç‡ (%)</th>
                    <th>ä»åœ¨é€”ç‡ (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in province_results %}
                <tr data-sku="{{ row.seller_sku }}">
                    <td>{{ loop.index }}</td>
                    <td class="fw-bold">{{ row.seller_sku }}</td>
                    <td>{{ row.province }}</td>
                    <td>{{ row.total }}</td>
                    <td>{{ row.share_rate }}</td>
                    <td>{{ row.sign_rate }}</td>
                    <td>{{ row.completed_rate }}</td>
                    <td>{{ row.delivered_rate }}</td>
                    <td>{{ row.refund_rate }}</td>
                    <td>{{ row.cancel_before_rate }}</td>
                    <td>{{ row.cancel_after_rate }}</td>
                    <td>{{ row.in_transit_rate }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

    <!-- è¯´æ˜ä¿¡æ¯ -->
    <div class="mt-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“‹ æŒ‡æ ‡è¯´æ˜</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>ç­¾æ”¶ç‡</strong> = å·²å®Œæˆç‡ + å·²é€è¾¾ç‡ + é€€æ¬¾ç‡</li>
                            <li><strong>å·²å®Œæˆç‡</strong> = çŠ¶æ€ä¸º"å·²å®Œæˆ"(`Completed`)ä¸”æ— å–æ¶ˆ/é€€è´§çš„è®¢å•æ¯”ä¾‹</li>
                            <li><strong>å·²é€è¾¾ç‡</strong> = çŠ¶æ€ä¸º"å·²é€è¾¾"(`Delivered`)çš„æ¯”ä¾‹</li>
                            <li><strong>é€€æ¬¾ç‡</strong> = è®¢å•çŠ¶æ€åŒ…å«"Return/Refund"çš„æ¯”ä¾‹</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>å‘è´§å‰å–æ¶ˆç‡</strong> = çŠ¶æ€ä¸º"å·²å–æ¶ˆ"(`Canceled`)ä¸”æœªå‘è´§çš„è®¢å•æ¯”ä¾‹</li>
                            <li><strong>å‘è´§åå–æ¶ˆç‡</strong> = çŠ¶æ€ä¸º"å·²å–æ¶ˆ"(`Canceled`)ä½†å·²å‘è´§çš„è®¢å•æ¯”ä¾‹</li>
                            <li><strong>ä»åœ¨é€”ç‡</strong> = çŠ¶æ€ä¸º"è¿è¾“ä¸­"(`In transit`)çš„æ¯”ä¾‹</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted mb-0">
                        <strong>é¢œè‰²è¯´æ˜ï¼š</strong>
                        <span class="percentage good">ç»¿è‰²</span> = è‰¯å¥½ï¼Œ
                        <span class="percentage warning">é»„è‰²</span> = ä¸€èˆ¬ï¼Œ
                        <span class="percentage danger">çº¢è‰²</span> = éœ€è¦å…³æ³¨
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// çœä»½è¡¨æ ¼æŒ‰ SKU è¿‡æ»¤
(function() {
    const skuFilter = document.getElementById('skuFilter');
    const table = document.getElementById('provinceTable');
    if (!skuFilter || !table) return;

    function applyFilter() {
        const val = skuFilter.value;
        const rows = table.querySelectorAll('tbody tr');
        let visibleIndex = 0;
        rows.forEach((tr) => {
            const rowSku = tr.getAttribute('data-sku');
            const match = !val || rowSku === val;
            if (match) {
                tr.classList.remove('d-none');
                const indexCell = tr.querySelector('td');
                if (indexCell) {
                    visibleIndex += 1;
                    indexCell.textContent = visibleIndex;
                }
            } else {
                tr.classList.add('d-none');
            }
        });
    }

    skuFilter.addEventListener('change', applyFilter);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 