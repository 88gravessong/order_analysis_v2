<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>计算结果 - 订单指标计算工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    <!-- 头部信息 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>📊 订单指标计算结果</h2>
        <a href="/" class="btn btn-outline-secondary">返回首页</a>
    </div>

	<!-- 汇总信息卡片（左：日期筛选；右：综合统计） -->
	<div class="row mb-4">
		<div class="col-md-6">
			<div class="card stats-card h-100">
				<div class="card-body">
					<form method="post" action="{{ url_for('process_province') if province_results else url_for('process') }}">
						<div class="row g-2 align-items-end">
							<div class="col-12">
								<small class="text-muted d-block mb-1">日期范围</small>
							</div>
							<div class="col-6">
								<label for="start_date" class="form-label mb-1">开始</label>
								<input type="date" id="start_date" name="start_date" class="form-control form-control-sm" value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" required>
							</div>
							<div class="col-6">
								<label for="end_date" class="form-label mb-1">结束</label>
								<input type="date" id="end_date" name="end_date" class="form-control form-control-sm" value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" required>
							</div>
							<div class="col-12 d-grid mt-1">
								<button type="submit" class="btn btn-primary btn-sm">重新计算</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card stats-card h-100">
				<div class="card-body stats-center text-center">
					<div class="row w-100">
						<div class="col-4">
							<h3 class="mb-1">{{ total_files }}</h3>
							<p class="mb-0">处理文件数</p>
						</div>
						<div class="col-4">
							<h3 class="mb-1">{{ sku_count }}</h3>
							<p class="mb-0">SKU 数量</p>
						</div>
						<div class="col-4">
							<h3 class="mb-1">{{ total_orders }}</h3>
							<p class="mb-0">总订单数</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

    <!-- 下载按钮 -->
    <div class="text-center mb-4">
        <a href="/download/{{ temp_filename }}" class="btn btn-success btn-lg px-4">
            📥 下载 Excel 文件
        </a>
    </div>

    <!-- 结果表格 -->
    <div class="card elevated">
        <div class="card-header">
            <h5 class="mb-0">详细指标数据</h5>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover mb-0">
                <thead class="sticky-top">
                    <tr>
                        <th>序号</th>
                        <th>Seller SKU</th>
                        <th>订单数</th>
                        <th>签收率 (%)</th>
                        <th>已完成率 (%)</th>
                        <th>已送达率 (%)</th>
                        <th>退款率 (%)</th>
                        <th>发货前取消率 (%)</th>
                        <th>发货后取消率 (%)</th>
                        <th>仍在途率 (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td class="fw-bold">{{ row.seller_sku }}</td>
                        <td>{{ row.total }}</td>
                        <td>
                            <span class="percentage {% if row.sign_rate >= 80 %}good{% elif row.sign_rate >= 60 %}warning{% else %}danger{% endif %}">
                                {{ row.sign_rate }}%
                            </span>
                        </td>
                        <td>
                            {{ row.completed_rate }}%
                        </td>
                        <td>
                            {{ row.delivered_rate }}%
                        </td>
                        <td>
                            <span class="percentage {% if row.refund_rate <= 5 %}good{% elif row.refund_rate <= 10 %}warning{% else %}danger{% endif %}">
                                {{ row.refund_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage {% if row.cancel_before_rate <= 5 %}good{% elif row.cancel_before_rate <= 10 %}warning{% else %}danger{% endif %}">
                                {{ row.cancel_before_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage {% if row.cancel_after_rate <= 3 %}good{% elif row.cancel_after_rate <= 8 %}warning{% else %}danger{% endif %}">
                                {{ row.cancel_after_rate }}%
                            </span>
                        </td>
                        <td>
                            <span class="percentage">{{ row.in_transit_rate }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% if province_results %}
<!-- SKU 过滤控件 -->
<div class="d-flex justify-content-start mb-2 mt-4">
    <div class="input-group" style="max-width: 360px;">
        <span class="input-group-text">Seller SKU</span>
        <select class="form-select" id="skuFilter">
            <option value="">全部</option>
            {% for g in province_results|groupby('seller_sku') %}
            <option value="{{ g.grouper }}">{{ g.grouper }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card elevated">
    <div class="card-header">
        <h5 class="mb-0">省份指标数据</h5>
    </div>
    <div class="table-container">
        <table class="table table-striped table-hover mb-0" id="provinceTable">
            <thead class="sticky-top">
                <tr>
                    <th>序号</th>
                    <th>Seller SKU</th>
                    <th>省份</th>
                    <th>订单数</th>
                    <th>订单占比 (%)</th>
                    <th>签收率 (%)</th>
                    <th>已完成率 (%)</th>
                    <th>已送达率 (%)</th>
                    <th>退款率 (%)</th>
                    <th>发货前取消率 (%)</th>
                    <th>发货后取消率 (%)</th>
                    <th>仍在途率 (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in province_results %}
                <tr data-sku="{{ row.seller_sku }}">
                    <td>{{ loop.index }}</td>
                    <td class="fw-bold">{{ row.seller_sku }}</td>
                    <td>{{ row.province }}</td>
                    <td>{{ row.total }}</td>
                    <td>{{ row.share_rate }}</td>
                    <td>{{ row.sign_rate }}</td>
                    <td>{{ row.completed_rate }}</td>
                    <td>{{ row.delivered_rate }}</td>
                    <td>{{ row.refund_rate }}</td>
                    <td>{{ row.cancel_before_rate }}</td>
                    <td>{{ row.cancel_after_rate }}</td>
                    <td>{{ row.in_transit_rate }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

    <!-- 说明信息 -->
    <div class="mt-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">📋 指标说明</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>签收率</strong> = 已完成率 + 已送达率 + 退款率</li>
                            <li><strong>已完成率</strong> = 状态为"已完成"(`Completed`)且无取消/退货的订单比例</li>
                            <li><strong>已送达率</strong> = 状态为"已送达"(`Delivered`)的比例</li>
                            <li><strong>退款率</strong> = 订单状态包含"Return/Refund"的比例</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>发货前取消率</strong> = 状态为"已取消"(`Canceled`)且未发货的订单比例</li>
                            <li><strong>发货后取消率</strong> = 状态为"已取消"(`Canceled`)但已发货的订单比例</li>
                            <li><strong>仍在途率</strong> = 状态为"运输中"(`In transit`)的比例</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted mb-0">
                        <strong>颜色说明：</strong>
                        <span class="percentage good">绿色</span> = 良好，
                        <span class="percentage warning">黄色</span> = 一般，
                        <span class="percentage danger">红色</span> = 需要关注
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 省份表格按 SKU 过滤
(function() {
    const skuFilter = document.getElementById('skuFilter');
    const table = document.getElementById('provinceTable');
    if (!skuFilter || !table) return;

    function applyFilter() {
        const val = skuFilter.value;
        const rows = table.querySelectorAll('tbody tr');
        let visibleIndex = 0;
        rows.forEach((tr) => {
            const rowSku = tr.getAttribute('data-sku');
            const match = !val || rowSku === val;
            if (match) {
                tr.classList.remove('d-none');
                const indexCell = tr.querySelector('td');
                if (indexCell) {
                    visibleIndex += 1;
                    indexCell.textContent = visibleIndex;
                }
            } else {
                tr.classList.add('d-none');
            }
        });
    }

    skuFilter.addEventListener('change', applyFilter);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 